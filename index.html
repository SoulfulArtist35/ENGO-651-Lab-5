<!DOCTYPE html> 
<html>
<head>
    <title>Phone Location and Temperature</title>

    <!--Link Stylesheets and JS Plugins-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <!--Leaflet-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!--Bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!---Custom Styling--> 
    <link rel="stylesheet" href="general.css">  

    <!--Overlapping Marker Spiderfier-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier-Leaflet/0.2.6/oms.min.js"></script>  

    <!--Marker Cluster -->
    <link rel = "stylesheet" href= "https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
    <link rel = "stylesheet" href= "https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js "></script> 

    <!--Paho-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

    <!---JS Functions-->
    <script type = "text/javascript">

        //Device Position      
        function success(pos) {
        console.log(pos); //Log position to console
        navigator.geolocation.clearWatch(id);
        } 


        //MQTT Required Functions
        var mqtt;
        var reconnectTimeout = 2000;

        //Online Host
        var host = "test.mosquitto.org";
        var port = 8081; //encrypted, unauthentication
        var Flag_SSL = true
        //var port = 8091; //encrypted, authenticated

        //Local Host
        //var host = "localhost"
        //var port = 1883;
         

        function onConnect(){
           console.log("Connected"); 
           mqtt.subscribe('ryan/651/mytest')
           document.getElementById("conn_stat").innerHTML= "Connection Established";
           conn_flag = 1;
           //message_payload = str({"msg" : "Connection Successful"})
           message = new Paho.MQTT.Message("Connection Successful");
           message.destinationName = 'ryan/651/mytest';
           mqtt.send(message);
        } 
        
        function disconnect(){
            if (conn_flag == 1) {
                conn_flag = 0;
                mqtt.disconnect();
                console.log("Disconnected")
                document.getElementById("conn_stat").innerHTML= "Disconnected from "  + host + " on " + port;
            }
        }
        function onFailure(message){
            console.log("Failed to Connect");
            document.getElementById("conn_stat").innerHTML= "<p> Failed to Connect to " + host + " on " + port+ "</p><p> Retrying Now";
            conn_flag = 0;  
            setTimeout(MQTTconnect, reconnectTimeout);
        } 

        function onLostConnection(){
            console.log("Connection dropped")
            document.getElementById("conn_stat").innerHTML= "Connection dropped: Re-Establishing Connection";
            if (conn_flag == 1){ 
                setTimeout(MQTTconnect, reconnectTimeout); 
            }
        } 

        function onMessageArrived(r_message){
            msg = r_message.payloadString;
            topic = r_message.destinationName;
            console.log(msg);
            document.getElementById("mess").innerHTML= "<p>Topic: "+ topic+ "</p>Message: " + msg + "</p>"

        }

        function MQTTconnect() {
            console.log("Connecting to " + host + " on " + port);
            document.getElementById("conn_stat").innerHTML= "Connecting to " + host + " on " + port;
            mqtt = new Paho.MQTT.Client(host, port, "clientjs");
            var options = {
                useSSL: Flag_SSL, //authentication
                cleanSession: true, 
                timeout: 2, //time given to connect
                onSuccess: onConnect,
                onFailure: onFailure,
            };  
            mqtt.onConnectionLost = onLostConnection;
            mqtt.onMessageArrived = onMessageArrived;

        mqtt.connect(options);
        
        } 

        function subscribe(){
            console.log("Subscribing") 
            var sub_topic = document.forms["subscribe_topic"]["in_topic"].value;
            mqtt.subscribe(sub_topic)
            console.log("Successfully subscribed to") //+ //sub_topic) 
            return false
        }


    </script>

</head>

<body> 
    <h2> Phone Tracker App </h2>
    <div class = "row">
        <div class = "col-sm">
            <p></p>
            <h3>Connection Status</h3>
            <p id = "conn_stat"></p>
            <!--MQTT Start/End Buttons-->
            <button class = "btn btn-success", onclick= "MQTTconnect()">Connect</button>
            <button class = "btn btn-danger", onclick = "disconnect()">End Connection</button> 
            <p><form name ="subscribe_topic", onsubmit="return subscribe()">
                <input type="text", placeholder = "topic", name = "in_topic">
                <p></p>
                <p><button class = "btn btn-secondary">Topic Subscribe</button></p>
            </form></p>           
            <p></p>
            <h3>Last Message</h3>
            <p id = "mess"></p>
            </p>
        </div>

        <div id = "map" , class = "col-lg"></div>

    <script> 
        document.getElementById("conn_stat").innerHTML= "Not Connected, Default Host and Port: "+  host + " on " + port; 
        
        var map = L.map('map').setView([51.04440912510035, -114.06310212367659], 11); //Calgary Tower Coordinates (Obtained from Google Maps)

        //Base Layer 
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(map) 


        //id = navigator.geolocation.watchPosition(success);

    </script>
    </div>
</body>



</html>
